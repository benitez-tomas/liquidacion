<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Procesador de Liquidaci칩n</title>
<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background: #f5f5f5;
}

textarea {
  width: 100%;
  height: 180px;
  margin-bottom: 15px;
  font-family: monospace;
  font-size: 13px;
}

button {
  padding: 10px 20px;
  margin-right: 10px;
  cursor: pointer;
}

table {
  border-collapse: collapse;
  margin-top: 20px;
  background: white;
}

th, td {
  border: 1px solid #ccc;
  padding: 4px 8px;
  font-size: 12px;
  text-align: center;
}

th { background: #eee; }

.mismatch { background: #ffd6d6; }
.correct { background: #d6ffd6; }

.tariff-row {
  background: #e6f2ff;
  font-weight: bold;
}
</style>
</head>
<body>

<h2>Procesador de Liquidaci칩n</h2>

<textarea id="input" placeholder="Peg치 ac치 la tabla copiada..."></textarea>
<button onclick="process()">Procesar</button>

<div id="result"></div>
<script>

function parseMoney(str) {
  if (!str) return 0;
  return Number(
    str.replace(/\$/g,"")
       .replace(/\./g,"")
       .replace(",",".")
       .replace(/\s/g,"")
  ) || 0;
}

function formatMoney(num) {
  return "$ " + num.toLocaleString("es-AR");
}

function process() {

  const input = document.getElementById("input").value.trim();
  if (!input) return;

  const rows = input.split("\n").map(r => r.split("\t"));

  // 游댳 CHANGE THESE INDEXES IF YOUR SHEET CHANGES
  const tariffColumns = [2,4,6,8]; // example: tariff columns
  const bonosIndex = 10;
  const excepcIndex = 11;
  const totalIndex = 12;

  // product columns must align with tariffColumns
  const productColumns = [1,3,5,7];

  // columns we keep (everything except tariff columns)
  const keptColumns = rows[0]
    .map((_, i) => i)
    .filter(i => !tariffColumns.includes(i));

  // get tariff value per tariff column (first non-zero found)
  const tariffs = {};

  tariffColumns.forEach(col => {
    for (let r = 1; r < rows.length; r++) {
      const val = parseMoney(rows[r][col]);
      if (val !== 0) {
        tariffs[col] = val;
        break;
      }
    }
  });

  let html = "<table><tr>";

  keptColumns.forEach(i => {
    html += "<th>"+rows[0][i]+"</th>";
  });

  html += "<th>TOTAL RECALCULADO</th><th>DIFERENCIA</th></tr>";

  for (let r = 1; r < rows.length; r++) {

    if (rows[r][0].toUpperCase().includes("SUMA")) continue;

    let total = 0;

    html += "<tr>";

    keptColumns.forEach(i => {
      html += "<td>"+(rows[r][i] || "")+"</td>";
    });

    // multiply qty 칑 tariff
    productColumns.forEach((prodCol, index) => {
      const tariffCol = tariffColumns[index];
      const qty = parseMoney(rows[r][prodCol]);
      const tariff = tariffs[tariffCol] || 0;
      total += qty * tariff;
    });

    // add bonos & excepc
    total += parseMoney(rows[r][bonosIndex]);
    total += parseMoney(rows[r][excepcIndex]);

    const originalTotal = parseMoney(rows[r][totalIndex]);
    const diff = total - originalTotal;

    html += "<td>"+formatMoney(total)+"</td>";

    html += `<td class="${diff !== 0 ? 'mismatch':'correct'}">${
      diff !== 0 ? formatMoney(diff) : "-"
    }</td>`;

    html += "</tr>";
  }

  html += "</table>";

  document.getElementById("result").innerHTML = html;
}

</script>


</body>
</html>
